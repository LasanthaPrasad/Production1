{% extends "base.html" %}
{% block content %}
<h1>Create Solar Plant</h1>
<form method="POST">
    {{ form.hidden_tag() }}
    <!-- ... other form fields ... -->
    <div class="form-group">
        {{ form.grid_substation.label }}
        {{ form.grid_substation(class="form-control", id="grid_substation") }}
    </div>
    <div class="form-group">
        {{ form.feeder.label }}
        {{ form.feeder(class="form-control", id="feeder") }}
    </div>
    <!-- ... rest of the form fields ... -->
    {{ form.submit(class="btn btn-primary") }}
</form>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM content loaded');
    var gridSubstationSelect = document.getElementById('grid_substation');
    var feederSelect = document.getElementById('feeder');

    function updateFeeders() {
        var substationId = gridSubstationSelect.value;
        console.log('Updating feeders for substation ID:', substationId);
        
        if (!substationId) {
            feederSelect.innerHTML = '<option value="">Select a Grid Substation first</option>';
            return;
        }

        feederSelect.innerHTML = '<option value="">Loading...</option>';
        
        fetch('/get_feeders/' + substationId)
            .then(response => {
                console.log('Fetch response received:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('Feeder data received:', data);
                feederSelect.innerHTML = '<option value="">Select a Feeder</option>';
                data.forEach(feeder => {
                    var option = document.createElement('option');
                    option.value = feeder.id;
                    option.textContent = feeder.name;
                    feederSelect.appendChild(option);
                });
            })
            .catch(error => {
                console.error('Error fetching feeders:', error);
                feederSelect.innerHTML = '<option value="">Error loading feeders</option>';
            });
    }

    gridSubstationSelect.addEventListener('change', function(event) {
        console.log('Grid substation changed:', event.target.value);
        updateFeeders();
    });

    // Initial call to set up feeder options if a grid substation is already selected
    if (gridSubstationSelect.value) {
        console.log('Initial grid substation value:', gridSubstationSelect.value);
        updateFeeders();
    }
});
</script>
{% endblock %}