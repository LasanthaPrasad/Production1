{% extends "base.html" %}
{% block content %}
<h1>Edit Solar Plant</h1>
<form method="POST">
    {{ form.hidden_tag() }}
    <div class="form-group">
        <label for="name">Name</label>
        <input type="text" class="form-control" id="name" name="name" value="{{ plant.name }}" required>
    </div>
    <div class="form-group">
        <label for="latitude">Latitude</label>
        <input type="number" step="any" class="form-control" id="latitude" name="latitude" value="{{ plant.latitude }}" required>
    </div>
    <div class="form-group">
        <label for="longitude">Longitude</label>
        <input type="number" step="any" class="form-control" id="longitude" name="longitude" value="{{ plant.longitude }}" required>
    </div>
    <div class="form-group">
        <label for="grid_substation">Grid Substation</label>
        <select class="form-control" id="grid_substation" name="grid_substation" required>
            {% for substation in substations %}
            <option value="{{ substation.id }}" {% if substation.id == plant.grid_substation %}selected{% endif %}>{{ substation.name }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="form-group">
        <label for="feeder">Feeder</label>
        <select class="form-control" id="feeder" name="feeder" required>
            <!-- Options will be populated dynamically based on selected substation -->
        </select>
    </div>
    <div class="form-group">
        <label for="forecast_location">Forecast Location</label>
        <select class="form-control" id="forecast_location" name="forecast_location" required>
            {% for location in forecast_locations %}
            <option value="{{ location.id }}" {% if location.id == plant.forecast_location %}selected{% endif %}>{{ location.provider_name }} ({{ location.latitude }}, {{ location.longitude }})</option>
            {% endfor %}
        </select>
    </div>
    <div class="form-group">
        <label for="installed_capacity">Installed Capacity (MW)</label>
        <input type="number" step="0.01" class="form-control" id="installed_capacity" name="installed_capacity" value="{{ plant.installed_capacity }}" required>
    </div>
    <div class="form-group">
        <label for="panel_capacity">Panel Capacity (MW)</label>
        <input type="number" step="0.01" class="form-control" id="panel_capacity" name="panel_capacity" value="{{ plant.panel_capacity }}" required>
    </div>
    <div class="form-group">
        <label for="inverter_capacity">Inverter Capacity (MW)</label>
        <input type="number" step="0.01" class="form-control" id="inverter_capacity" name="inverter_capacity" value="{{ plant.inverter_capacity }}" required>
    </div>
    <div class="form-group">
        <label for="plant_angle">Plant Angle</label>
        <input type="number" step="0.01" class="form-control" id="plant_angle" name="plant_angle" value="{{ plant.plant_angle }}" required>
    </div>
    <div class="form-group">
        <label for="company">Company</label>
        <input type="text" class="form-control" id="company" name="company" value="{{ plant.company }}" required>
    </div>
    <div class="form-group">
        <label for="api_status">API Status</label>
        <select class="form-control" id="api_status" name="api_status" required>
            <option value="enabled" {% if plant.api_status == 'enabled' %}selected{% endif %}>Enabled</option>
            <option value="disabled" {% if plant.api_status == 'disabled' %}selected{% endif %}>Disabled</option>
        </select>
    </div>
    <div class="form-group">
        <label for="plant_efficiency">Plant Efficiency</label>
        <input type="number" step="0.01" class="form-control" id="plant_efficiency" name="plant_efficiency" value="{{ plant.plant_efficiency }}" required>
    </div>
    <div class="form-group">
        <label for="coefficient_factor">Coefficient Factor</label>
        <input type="number" step="0.01" class="form-control" id="coefficient_factor" name="coefficient_factor" value="{{ plant.coefficient_factor }}" required>
    </div>
    <button type="submit" class="btn btn-primary">Update Solar Plant</button>
</form>
{% endblock %}

{% block scripts %}
<script>
    // Function to populate feeders
    function populateFeeders(substationId, selectedFeederId) {
        var feederSelect = document.getElementById('feeder');
        // Clear current options
        feederSelect.innerHTML = '';
        // Fetch feeders for selected substation
        fetch('/get_feeders/' + substationId)
            .then(response => response.json())
            .then(data => {
                data.forEach(feeder => {
                    var option = document.createElement('option');
                    option.value = feeder.id;
                    option.textContent = feeder.name;
                    if (feeder.id == selectedFeederId) {
                        option.selected = true;
                    }
                    feederSelect.appendChild(option);
                });
            });
    }

    // Populate feeders on page load
    document.addEventListener('DOMContentLoaded', function() {
        var substationId = document.getElementById('grid_substation').value;
        var selectedFeederId = {{ plant.feeder }};
        populateFeeders(substationId, selectedFeederId);
    });

    // Update feeders when substation changes
    document.getElementById('grid_substation').addEventListener('change', function() {
        var substationId = this.value;
        populateFeeders(substationId);
    });
</script>
{% endblock %}